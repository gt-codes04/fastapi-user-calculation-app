<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Calculations (BREAD)</title>
</head>
<body>
  <h1>Calculations (BREAD)</h1>

  <p>
    <a href="/login-page">Go to Login</a> |
    <a href="/report-page">Go to Reports</a> |
    <a href="/register-page">Go to Register</a> |
    <a href="/profile-page">Go to Profile</a>
  </p>

  <!-- Auth status -->
  <p id="auth-status" style="color: red;"></p>

  <h2>Add New Calculation</h2>
  <div>
    A: <input id="a-input" type="number" value="2" />
    B: <input id="b-input" type="number" value="3" />
    Operation:
    <select id="op-select">
      <option value="add">add</option>
      <option value="sub">sub</option>
      <option value="mul">mul</option>
      <option value="div">div</option>
      <option value="pow">pow</option>
    </select>
    <button id="create-btn" type="button">Create</button>
  </div>

  <p id="create-error" style="color: red;"></p>

  <h2>Your Calculations</h2>
  <table border="1" cellpadding="4" cellspacing="0">
    <thead>
      <tr>
        <th>ID</th>
        <th>A</th>
        <th>B</th>
        <th>Type</th>
        <th>Result</th>
        <th>Edit</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody id="calc-body"></tbody>
  </table>

  <script>
    const BASE_URL = "http://localhost:8000";

    // âœ… use the same key "token", with fallback
    function getToken() {
      const t = localStorage.getItem("token") || localStorage.getItem("access_token");
      console.log("Using token from localStorage:", t);
      return t;
    }

    async function loadCalculations() {
      const token = getToken();
      const statusEl = document.getElementById("auth-status");
      const tbody = document.getElementById("calc-body");
      tbody.innerHTML = "";

      if (!token) {
        statusEl.style.color = "red";
        statusEl.textContent = "No token found. Redirecting to login...";
        // auto-redirect to login
        setTimeout(() => {
          window.location.href = "/login-page";
        }, 1000);
        return;
      }

      statusEl.style.color = "green";
      statusEl.textContent = "Authenticated.";

      try {
        const resp = await fetch(`${BASE_URL}/calculations/`, {
          method: "GET",
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        if (!resp.ok) {
          statusEl.style.color = "red";
          statusEl.textContent = "Failed to load calculations (status " + resp.status + ")";
          console.log("Load calculations response:", resp.status);
          return;
        }

        const items = await resp.json();
        for (const calc of items) {
          const tr = document.createElement("tr");

          const idTd = document.createElement("td");
          idTd.textContent = calc.id;
          tr.appendChild(idTd);

          const aTd = document.createElement("td");
          aTd.textContent = calc.a;
          tr.appendChild(aTd);

          const bTd = document.createElement("td");
          bTd.textContent = calc.b;
          tr.appendChild(bTd);

          const typeTd = document.createElement("td");
          typeTd.textContent = calc.type;
          tr.appendChild(typeTd);

          const resultTd = document.createElement("td");
          resultTd.textContent = calc.result;
          tr.appendChild(resultTd);

          // Edit placeholder
          const editTd = document.createElement("td");
          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.onclick = () =>
            alert("Edit via API /calculations/" + calc.id + " (already tested by integration)");
          editTd.appendChild(editBtn);
          tr.appendChild(editTd);

          // Delete
          const delTd = document.createElement("td");
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.onclick = () => deleteCalculation(calc.id);
          delTd.appendChild(delBtn);
          tr.appendChild(delTd);

          tbody.appendChild(tr);
        }
      } catch (err) {
        console.error("Error loading calculations:", err);
        statusEl.style.color = "red";
        statusEl.textContent = "Error loading calculations.";
      }
    }

    async function createCalculation() {
      const token = getToken();
      const errorEl = document.getElementById("create-error");
      errorEl.textContent = "";

      if (!token) {
        errorEl.textContent = "Not authenticated";
        return;
      }

      const aVal = parseFloat(document.getElementById("a-input").value);
      const bVal = parseFloat(document.getElementById("b-input").value);
      const opVal = document.getElementById("op-select").value;

      try {
        const resp = await fetch(`${BASE_URL}/calculations/?owner_id=0`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + token
          },
          body: JSON.stringify({ a: aVal, b: bVal, type: opVal })
        });

        if (!resp.ok) {
          const data = await resp.json().catch(() => ({}));
          console.error("Create error:", resp.status, data);
          errorEl.textContent = "Create failed (status " + resp.status + ")";
          return;
        }

        await loadCalculations();
      } catch (err) {
        console.error("Create error:", err);
        errorEl.textContent = "Create failed. See console.";
      }
    }

    async function deleteCalculation(id) {
      const token = getToken();
      const statusEl = document.getElementById("auth-status");

      if (!token) {
        statusEl.style.color = "red";
        statusEl.textContent = "Not authenticated";
        return;
      }

      try {
        const resp = await fetch(`${BASE_URL}/calculations/` + id, {
          method: "DELETE",
          headers: {
            "Authorization": "Bearer " + token
          }
        });

        if (!resp.ok) {
          statusEl.style.color = "red";
          statusEl.textContent = "Delete failed (status " + resp.status + ")";
          console.log("Delete resp status:", resp.status);
          return;
        }

        await loadCalculations();
      } catch (err) {
        console.error("Delete error:", err);
        statusEl.style.color = "red";
        statusEl.textContent = "Delete failed. See console.";
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("create-btn").addEventListener("click", createCalculation);
      loadCalculations();
    });
  </script>
</body>
</html>
